



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for batect, the build and testing environments as code tool">
      
      
        <link rel="canonical" href="https://batect.charleskorn.com/GettingStarted.html">
      
      
        <meta name="author" content="Charles Korn">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Getting started tutorial - batect documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-63947227-2", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#getting-started-tutorial" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://batect.charleskorn.com" title="batect documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              batect documentation
            </span>
            <span class="md-header-nav__topic">
              Getting started tutorial
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/charleskorn/batect/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    charleskorn/batect
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://batect.charleskorn.com" title="batect documentation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    batect documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/charleskorn/batect/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    charleskorn/batect
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="QuickStart.html" title="Quick start" class="md-nav__link">
      Quick start
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Getting started tutorial
      </label>
    
    <a href="GettingStarted.html" title="Getting started tutorial" class="md-nav__link md-nav__link--active">
      Getting started tutorial
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#first-steps-build-environment" title="First steps: build environment" class="md-nav__link">
    First steps: build environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#taking-it-further-integration-and-journey-test-environments" title="Taking it further: integration and journey test environments" class="md-nav__link">
    Taking it further: integration and journey test environments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-next" title="Where next?" class="md-nav__link">
    Where next?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="Comparison.html" title="Comparison with other tools" class="md-nav__link">
      Comparison with other tools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Configuration file reference
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Configuration file reference
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="config/Overview.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="config/Containers.html" title="Containers" class="md-nav__link">
      Containers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="config/Tasks.html" title="Tasks" class="md-nav__link">
      Tasks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Language and tool-specific information
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Language and tool-specific information
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="tools/Java.html" title="Java" class="md-nav__link">
      Java
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tools/Ruby.html" title="Ruby" class="md-nav__link">
      Ruby
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tools/Docker.html" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Tips and tricks
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Tips and tricks
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="tips/CISetup.html" title="CI setup" class="md-nav__link">
      CI setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tips/IDEIntegration.html" title="IDE integration" class="md-nav__link">
      IDE integration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tips/Performance.html" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tips/BuildArtifactsOwnedByRoot.html" title="Build artifacts are owned by root" class="md-nav__link">
      Build artifacts are owned by root
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tips/WaitingForDependenciesToBeReady.html" title="Waiting for dependencies to be ready" class="md-nav__link">
      Waiting for dependencies to be ready
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="tips/Proxies.html" title="Proxies" class="md-nav__link">
      Proxies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="SampleProjects.html" title="Sample projects" class="md-nav__link">
      Sample projects
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://github.com/charleskorn/batect/releases" title="Release notes" class="md-nav__link">
      Release notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://github.com/charleskorn/batect/blob/master/ROADMAP.md" title="Roadmap" class="md-nav__link">
      Roadmap
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#first-steps-build-environment" title="First steps: build environment" class="md-nav__link">
    First steps: build environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#taking-it-further-integration-and-journey-test-environments" title="Taking it further: integration and journey test environments" class="md-nav__link">
    Taking it further: integration and journey test environments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-next" title="Where next?" class="md-nav__link">
    Where next?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/charleskorn/batect/edit/master/docs/content/GettingStarted.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="getting-started-tutorial">Getting started tutorial<a class="headerlink" href="#getting-started-tutorial" title="Permanent link">&para;</a></h1>
<p>The samples shown below are taken from the <a href="https://github.com/charleskorn/batect-sample-java">Java sample project</a>.</p>
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h2>
<p>Before you begin, follow the <a href="QuickStart.html">installation steps</a> to setup batect.</p>
<h2 id="first-steps-build-environment">First steps: build environment<a class="headerlink" href="#first-steps-build-environment" title="Permanent link">&para;</a></h2>
<p>To start, we're going to configure a simple build environment, where you can build your application and run unit
tests. This example is for a Java project that uses Gradle, and assumes that you already have Gradle set up for your project.</p>
<ol>
<li>
<p>Create a <code>batect.yml</code> configuration file in the root of your project. For example:</p>
<div class="codehilite"><pre><span></span><span class="nt">containers</span><span class="p">:</span>
  <span class="nt">build-env</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">openjdk:8u141-jdk</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">local</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
        <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code</span>
        <span class="nt">options</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cached</span>
      <span class="p p-Indicator">-</span> <span class="nt">local</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.gradle-cache</span>
        <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/container-user/.gradle</span>
        <span class="nt">options</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cached</span>
    <span class="nt">working_directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">GRADLE_OPTS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">-Dorg.gradle.daemon=false</span>
    <span class="nt">run_as_current_user</span><span class="p">:</span>
      <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">home_directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/container-user</span>

<span class="nt">tasks</span><span class="p">:</span>
  <span class="nt">build</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build the application.</span>
    <span class="nt">run</span><span class="p">:</span>
      <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build-env</span>
      <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./gradlew assembleDist</span>

  <span class="nt">unitTest</span><span class="p">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run the unit tests.</span>
    <span class="nt">run</span><span class="p">:</span>
      <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build-env</span>
      <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./gradlew test</span>
</pre></div>

<p>There's a bit going on here, so let's break it down:</p>
<ul>
<li><code>project_name</code>: the name of your project.</li>
<li><code>containers</code>: here we define the different containers that your application needs.
  At the moment, we just have our one build environment container, <code>build-env</code>.<ul>
<li>We tell batect which Docker image to use (<code>image</code>).</li>
<li>We tell it to mount the project (<code>.</code>, the current directory) into the container at <code>/code</code>, and to start
   the container in that directory (<code>working_directory</code>).</li>
<li>We also mount <code>.gradle-cache</code> into the container as <code>/root/.gradle</code> - this allows Gradle to cache
   dependencies between builds, rather than downloading them on every single run. (You probably want to
   add this directory to your <code>.gitignore</code>.)</li>
<li>We use <code>:cached</code> mode for the mounts to improve performance on OS X (see
   <a href="tips/Performance.html#io-performance">this page</a> for more information). This has no effect on other operating systems.</li>
<li>We disable the <a href="https://docs.gradle.org/current/userguide/gradle_daemon.html">Gradle daemon</a>, as running
   it is pointless given that we create a new container for every run.</li>
<li>We enable <a href="config/Containers.html#run_as_current_user">run as current user mode</a> to ensure that any build artifacts are
   owned by you, and not <code>root</code>.</li>
</ul>
</li>
<li><code>tasks</code>: we define our two tasks, one for building the application, and another for running the unit tests.
  These just run the existing Gradle tasks within the build environment we just defined.</li>
</ul>
<p>You can define whatever tasks you want - common other tasks you might like to add include one that starts a
  shell in the build environment (eg. one with <code>command: bash</code>) and another that automatically runs the unit
  tests whenever the code is changed (eg. <code>command: ./gradlew --continuous test</code>).</p>
<p>For more information on <code>batect.yml</code>, consult the <a href="config/Overview.html">documentation</a>.</p>
</li>
<li>
<p>Run <code>./batect --list-tasks</code>, and you'll see the tasks that we just defined:</p>
<div class="codehilite"><pre><span></span>Available tasks:
- build: Build the application.
- unitTest: Run the unit tests.
</pre></div>

</li>
<li>
<p>Run <code>./batect build</code> and batect will pull the image used for your build environment, start it and run Gradle within it.
   (Note that this may take a while the first time as the Docker image must be downloaded first.)</p>
</li>
<li>
<p>Similarly, if you run <code>./batect unitTest</code>, batect will start a build environment, run your unit tests within it, and then
   clean up the build environment.</p>
</li>
</ol>
<p>That's it! Your builds and unit tests now run in an isolated and consistent build environment, and you can easily change the
configuration of your build environment without having to install or configure anything manually on every developer or CI machine.</p>
<h2 id="taking-it-further-integration-and-journey-test-environments">Taking it further: integration and journey test environments<a class="headerlink" href="#taking-it-further-integration-and-journey-test-environments" title="Permanent link">&para;</a></h2>
<p>So we've set up an isolated and repeatable build environment. However, where batect really shines is setting up integration and
journey test environments - environments that require spinning up real (or fake) versions of dependencies such as databases or downstream services.</p>
<p>Let's imagine our application just has one dependency, a Postgres database. We can define a Docker image for this with a Dockerfile:</p>
<div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> postgres:9.6.2</span>
</pre></div>

<p>Save this as <code>dev-infrastructure/database/Dockerfile</code>.</p>
<p>So far, so good - this is just like what we had before for the build environment. However, this will start an empty Postgres database,
and our application probably needs at least a database and a table or two. Create a SQL script called <code>create-structure.sql</code> that creates
your database tables and save it in the <code>dev-infrastructure/database</code> folder you just created.</p>
<p>We can then take advantage of a feature of the <a href="https://hub.docker.com/r/library/postgres/">standard Postgres image</a> to have this SQL
script run when the container starts. Any <code>.sql</code> file in the <code>/docker-entrypoint-initdb.d</code> directory will automatically be run when
the container starts, so if we copy our <code>create-structure.sql</code> script into that directory in the image, then whenever it is started,
our database structure will be created. So our Dockerfile now looks like:</p>
<div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> postgres:9.6.2</span>

<span class="k">COPY</span> create-structure.sql /docker-entrypoint-initdb.d/
</pre></div>

<p>There's one last thing we need to think about though. When Docker starts our database container, all we know is that the container has
started - we have no way to know if the database is actually ready for use. If we want to run tests against our database, we don't want
to start running those tests until it's actually ready to use. While Postgres is usually pretty fast to start up, it's not instantaneous,
and other things can take anywhere from a few moments to a minute or two to start up and be ready. We can use
<a href="https://docs.docker.com/engine/reference/builder/#healthcheck">Docker's health check feature</a> to indicate when a container is ready for use.</p>
<p>In our case, we can take <a href="https://github.com/charleskorn/batect-sample-java/tree/master/dev-infrastructure/database/health-check.sh">the health check script</a>
from the sample project and copy it into our <code>dev-infrastructure/database</code> folder. All it does is try to issue a simple query against the
database - if that succeeds, we can assume that the database is up and running. (There's
<a href="https://github.com/docker-library/healthcheck/">a collection of sample health check scripts provided by Docker</a> you can use.)</p>
<p>Then we need to tell Docker where to find our health check script, so we need to add it to our Dockerfile:</p>
<div class="codehilite"><pre><span></span><span class="k">FROM</span><span class="s"> postgres:9.6.2</span>

<span class="k">RUN</span> mkdir -p /tools
<span class="k">COPY</span> health-check.sh /tools/
<span class="k">HEALTHCHECK</span> --interval<span class="o">=</span>2s <span class="k">CMD</span> /tools/health-check.sh

<span class="k">COPY</span> create-structure.sql /docker-entrypoint-initdb.d/
</pre></div>

<p>So, now we have a Dockerfile that describes how to start up our database, and how to tell when it's ready for use. Now we just need to configure
batect to run our tests.</p>
<p>First of all, let's define our database container:</p>
<div class="codehilite"><pre><span></span><span class="nt">containers</span><span class="p">:</span>

  <span class="l l-Scalar l-Scalar-Plain">...</span>

  <span class="l l-Scalar l-Scalar-Plain">database</span><span class="p p-Indicator">:</span>
    <span class="nt">build_directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dev-infrastructure/database</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=international-transfers-service-user</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=TheSuperSecretPassword</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_DB=international-transfers-service</span>
</pre></div>

<p>This uses the environment variables defined by the Postgres image to set the username, password and database name to use to connect to it. We
could have specified them in the Dockerfile with <code>ENV</code> statements, but this works as well.</p>
<p>Then we just need to define our integration test task:</p>
<div class="codehilite"><pre><span></span><span class="nt">tasks</span><span class="p">:</span>

  <span class="l l-Scalar l-Scalar-Plain">...</span>

  <span class="l l-Scalar l-Scalar-Plain">integrationTest</span><span class="p p-Indicator">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run the integration tests.</span>
    <span class="nt">run</span><span class="p">:</span>
      <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build-env</span>
      <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./gradlew integrationTest</span>
    <span class="nt">start</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">database</span>
</pre></div>

<p>This is just like the build and unit test tasks we defined before, but we now also specify our database container in <code>start</code>. batect will start
any containers listed in <code>start</code> and wait for them to become healthy before starting the container given in <code>run</code>.</p>
<p>Under the covers, batect will also create an isolated network for all of the task's containers, so that they can communicate with one another
without interfering with anything else on your machine. (They'll still have access to the internet and anything else they could access if they
were running directly on your machine though.) This means that the integration tests just need to connect to the host <code>database</code> with the username
<code>international-transfers-service-user</code> and password <code>TheSuperSecretPassword</code>, and Docker will automatically forward that to the database container.</p>
<p>And, after your tests have finished, batect will then remove all the containers it started, leaving your machine in the same state it was before
you started.</p>
<p>Similarly, if we want to run some journey tests that test our application end-to-end, we just need to create a Dockerfile for our application,
then define it in <code>batect.yml</code>:</p>
<div class="codehilite"><pre><span></span><span class="nt">containers</span><span class="p">:</span>

  <span class="l l-Scalar l-Scalar-Plain">...</span>

  <span class="l l-Scalar l-Scalar-Plain">international-transfers-service</span><span class="p p-Indicator">:</span>
    <span class="nt">build_directory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dev-infrastructure/international-transfers-service</span>
    <span class="nt">dependencies</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">database</span>
</pre></div>

<p>...and then add a task:</p>
<div class="codehilite"><pre><span></span><span class="nt">tasks</span><span class="p">:</span>

  <span class="l l-Scalar l-Scalar-Plain">...</span>

  <span class="l l-Scalar l-Scalar-Plain">journeyTest</span><span class="p p-Indicator">:</span>
    <span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Run the journey tests.</span>
    <span class="nt">run</span><span class="p">:</span>
      <span class="nt">container</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build-env</span>
      <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./gradlew journeyTest</span>
    <span class="nt">start</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">international-transfers-service</span>
    <span class="nt">prerequisites</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">build</span>
</pre></div>

<p>Note that in this case, we specify that the database container is a dependency of the application container - this means that batect will first
start the database container and wait for it to become healthy, then start the application and wait for it to become healthy, and then run the
journey tests. We also specify that the build task should run before starting the journey tests - this is so that when we start the application,
we start the most recent version of it.</p>
<h2 id="where-next">Where next?<a class="headerlink" href="#where-next" title="Permanent link">&para;</a></h2>
<p>There's a comprehensive <a href="config/Overview.html">reference page for the configuration file</a>, and a number of <a href="SampleProjects.html">sample applications</a>
you can take a look at.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="QuickStart.html" title="Quick start" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Quick start
              </span>
            </div>
          </a>
        
        
          <a href="Comparison.html" title="Comparison with other tools" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Comparison with other tools
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017-2019 Charles Korn.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="assets/fonts/font-awesome.css">
    
      <a href="https://github.com/charleskorn/batect" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
  </body>
</html>